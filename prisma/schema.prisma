generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  password      String?
  isAdmin       Boolean   @default(false) @map("is_admin")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  accounts      Account[]
  sessions      Session[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Profile {
  id        String   @id
  email     String?  @unique
  fullName  String?  @map("full_name")
  phone     String?
  isAdmin   Boolean  @default(false) @map("is_admin")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("profiles")
}

model Application {
  id                String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId            String?       @map("user_id")
  productType       String?       @map("product_type")
  propertyType      String?       @map("property_type")
  propertyUsage     String?       @map("property_usage")
  propertyValue     Decimal?      @map("property_value")
  loanAmount        Decimal?      @map("loan_amount")
  zipCode           String?       @map("zip_code")
  employmentStatus  String?       @map("employment_status")
  annualIncome      Decimal?      @map("annual_income")
  liquidAssets      Decimal?      @map("liquid_assets")
  creditScore       Int?          @map("credit_score")
  creditScoreSource String?       @map("credit_score_source")
  creditScoreDate   DateTime?     @map("credit_score_date") @db.Date
  creditNotes       String?       @map("credit_notes")
  ssnEncrypted      String?       @map("ssn_encrypted")
  consentSoftPull   Boolean       @default(false) @map("consent_soft_pull")
  consentSignedAt   DateTime?     @map("consent_signed_at")
  consentSignedName String?       @map("consent_signed_name")
  consentIpAddress  String?       @map("consent_ip_address")
  dtiRatio          Decimal?      @map("dti_ratio")
  status            String        @default("pending")
  adminNotes        String?       @map("admin_notes")
  createdAt         DateTime      @default(now()) @map("created_at")
  updatedAt         DateTime      @updatedAt @map("updated_at")
  offersPublishedAt DateTime?     @map("offers_published_at")
  newUserId         String?       @map("new_user_id")
  propertyState     String?       @map("property_state") @db.VarChar(2)
  propertyAddress   String?       @map("property_address")
  propertyCity      String?       @map("property_city")
  propertyCounty    String?       @map("property_county")

  // ── 1003 Borrower Details (Pre-Approval Modal) ──
  dateOfBirth           DateTime? @map("date_of_birth") @db.Date
  maritalStatus         String?   @map("marital_status")
  firstTimeHomeBuyer    Boolean?  @map("first_time_home_buyer")
  preferredLanguage     String?   @map("preferred_language")

  // ── Current Mailing Address ──
  mailingAddress        String?   @map("mailing_address")
  mailingUnit           String?   @map("mailing_unit")
  mailingCity           String?   @map("mailing_city")
  mailingState          String?   @map("mailing_state") @db.VarChar(2)
  mailingZipCode        String?   @map("mailing_zip_code")
  addressDurationMonths Int?      @map("address_duration_months")
  housingStatus         String?   @map("housing_status")

  // ── Employment Details ──
  employerName          String?   @map("employer_name")
  employerPosition      String?   @map("employer_position")
  employerPhone         String?   @map("employer_phone")
  employmentStartDate   DateTime? @map("employment_start_date") @db.Date
  selfEmployed          Boolean?  @map("self_employed")

  // ── Loan Preferences ──
  downPayment           Decimal?  @map("down_payment")
  mortgageType          String?   @map("mortgage_type")
  loanTerm              Int?      @map("loan_term")
  amortizationType      String?   @map("amortization_type")
  numberOfUnits         Int?      @map("number_of_units")

  // ── Co-Borrower ──
  hasCoBorrower         Boolean?  @map("has_co_borrower")
  coBorrowerFirstName   String?   @map("co_borrower_first_name")
  coBorrowerLastName    String?   @map("co_borrower_last_name")
  coBorrowerEmail       String?   @map("co_borrower_email")
  coBorrowerPhone       String?   @map("co_borrower_phone")
  coBorrowerDob         DateTime? @map("co_borrower_dob") @db.Date

  // ── Arive / Zapier Integration ──
  ariveLoanId           String?   @map("arive_loan_id")
  ariveDeepLink         String?   @map("arive_deep_link")
  zapierPushStatus      String?   @map("zapier_push_status")
  zapierPushedAt        DateTime? @map("zapier_pushed_at")

  // ── Pre-Approval Status ──
  preApprovalSubmittedAt DateTime? @map("pre_approval_submitted_at")
  preApprovalComplete    Boolean   @default(false) @map("pre_approval_complete")

  // ── Relations ──
  lenderOffers           LenderOffer[]
  properties             Property[]
  disclosureSignatures   DisclosureSignature[]

  @@index([status], map: "idx_applications_status")
  @@index([userId], map: "idx_applications_user_id")
  @@index([newUserId], map: "idx_applications_new_user_id")
  @@index([createdAt], map: "idx_applications_created_at")
  @@map("applications")
}

model LenderOffer {
  id              String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  applicationId   String      @map("application_id") @db.Uuid
  lenderName      String      @map("lender_name")
  interestRate    Decimal?    @map("interest_rate")
  apr             Decimal?
  monthlyPayment  Decimal?    @map("monthly_payment")
  loanTerm        Int?        @map("loan_term")
  closingCosts    Decimal?    @map("closing_costs")
  isRecommended   Boolean     @default(false) @map("is_recommended")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  isBestMatch     Boolean     @default(false) @map("is_best_match")
  isVisible       Boolean     @default(true) @map("is_visible")
  lenderLogo      String?     @map("lender_logo")
  productName     String?     @map("product_name")
  loanType        String?     @map("loan_type")
  points          Decimal?    @map("points")
  originationFee  Decimal?    @map("origination_fee")
  rateLockDays    Int?        @map("rate_lock_days")
  rateLockExpires DateTime?   @map("rate_lock_expires") @db.Date
  source          String?     @default("manual") @map("source")
  externalId      String?     @map("external_id")
  application     Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId], map: "idx_lender_offers_application_id")
  @@map("lender_offers")
}

model Property {
  id            String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String      @map("user_id")
  applicationId String?     @map("application_id") @db.Uuid
  addressLine1  String      @map("address_line1")
  city          String
  state         String      @db.VarChar(2)
  zipCode       String      @map("zip_code")
  county        String?
  price         Decimal?
  bedrooms      Int?
  bathrooms     Decimal?
  squareFootage Int?        @map("square_footage")
  yearBuilt     Int?        @map("year_built")
  propertyType  String?     @map("property_type")
  lotSize       Decimal?    @map("lot_size")
  status        String?     @default("For Sale")
  imageUrl      String?     @map("image_url")
  description   String?
  daysOnMarket  Int?        @map("days_on_market")
  isChosen      Boolean     @default(false) @map("is_chosen")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  application   Application? @relation(fields: [applicationId], references: [id], onDelete: SetNull)

  @@index([userId], map: "idx_properties_user_id")
  @@index([applicationId], map: "idx_properties_application_id")
  @@index([userId, isChosen], map: "idx_properties_user_chosen")
  @@map("properties")
}

model AdminActivityLog {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  adminId    String   @map("admin_id")
  action     String
  targetType String?  @map("target_type")
  targetId   String?  @map("target_id")
  details    Json?
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([adminId], map: "idx_admin_activity_admin_id")
  @@index([createdAt], map: "idx_admin_activity_created_at")
  @@map("admin_activity_log")
}

model SystemMetric {
  key       String   @id
  value     Json
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_metrics")
}

model Document {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String   @map("user_id")
  applicationId  String?  @map("application_id") @db.Uuid
  category       String
  fileName       String   @map("file_name")
  storageKey     String   @map("storage_key")
  fileSize       Int?     @map("file_size")
  mimeType       String?  @map("mime_type")
  uploadedBy     String   @map("uploaded_by")
  uploadedByName String?  @map("uploaded_by_name")
  status         String   @default("pending_review")
  adminNotes     String?  @map("admin_notes")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@index([userId], map: "idx_documents_user_id")
  @@index([applicationId], map: "idx_documents_application_id")
  @@index([category], map: "idx_documents_category")
  @@map("documents")
}

model DocumentRequest {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  applicationId String   @map("application_id") @db.Uuid
  title         String
  category      String?
  instructions  String?
  status        String   @default("requested")
  createdBy     String   @map("created_by")
  fulfilledAt   DateTime? @map("fulfilled_at")
  cancelledAt   DateTime? @map("cancelled_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([applicationId], map: "idx_document_requests_application_id")
  @@index([status], map: "idx_document_requests_status")
  @@map("document_requests")
}

model MessageThread {
  id        String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String          @map("user_id")
  subject   String
  status    String          @default("open")
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")
  replies   MessageReply[]

  @@index([userId], map: "idx_message_threads_user_id")
  @@index([status], map: "idx_message_threads_status")
  @@index([updatedAt], map: "idx_message_threads_updated_at")
  @@map("message_threads")
}

model MessageReply {
  id        String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  threadId  String        @map("thread_id") @db.Uuid
  senderId  String        @map("sender_id")
  senderRole String       @map("sender_role")
  senderName String?      @map("sender_name")
  body      String
  isRead    Boolean       @default(false) @map("is_read")
  createdAt DateTime      @default(now()) @map("created_at")
  thread    MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId], map: "idx_message_replies_thread_id")
  @@index([senderId], map: "idx_message_replies_sender_id")
  @@map("message_replies")
}

model DisclosureSignature {
  id               String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  applicationId    String      @map("application_id") @db.Uuid
  disclosureType   String      @map("disclosure_type")
  documentId       String?     @map("document_id") @db.Uuid
  signedName       String?     @map("signed_name")
  signedAt         DateTime?   @map("signed_at")
  signedIp         String?     @map("signed_ip")
  status           String      @default("pending_signature")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  application      Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId], map: "idx_disclosure_signatures_application_id")
  @@index([disclosureType], map: "idx_disclosure_signatures_type")
  @@map("disclosure_signatures")
}
