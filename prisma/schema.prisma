// Prisma Schema for Lumina Platform
// Migrated from Supabase to DigitalOcean PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// NextAuth Models
// ==========================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  password      String?
  isAdmin       Boolean   @default(false) @map("is_admin")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  accounts      Account[]
  sessions      Session[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ==========================================
// Legacy Tables (from Supabase migration)
// These work independently with user_id as UUID string
// ==========================================

model Profile {
  id          String   @id
  email       String?  @unique
  fullName    String?  @map("full_name")
  phone       String?
  isAdmin     Boolean  @default(false) @map("is_admin")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("profiles")
}

model Application {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId              String?   @map("user_id")
  newUserId           String?   @map("new_user_id")
  productType         String?   @map("product_type")
  propertyType        String?   @map("property_type")
  propertyUsage       String?   @map("property_usage")
  propertyValue       Decimal?  @map("property_value")
  loanAmount          Decimal?  @map("loan_amount")
  zipCode             String?   @map("zip_code")
  employmentStatus    String?   @map("employment_status")
  annualIncome        Decimal?  @map("annual_income")
  liquidAssets        Decimal?  @map("liquid_assets")
  creditScore         Int?      @map("credit_score")
  creditScoreSource   String?   @map("credit_score_source")
  creditScoreDate     DateTime? @map("credit_score_date") @db.Date
  creditNotes         String?   @map("credit_notes")
  dtiRatio            Decimal?  @map("dti_ratio")
  status              String    @default("pending")
  adminNotes          String?   @map("admin_notes")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  offersPublishedAt   DateTime? @map("offers_published_at")

  lenderOffers LenderOffer[]

  @@index([status], name: "idx_applications_status")
  @@index([userId], name: "idx_applications_user_id")
  @@index([newUserId], name: "idx_applications_new_user_id")
  @@index([createdAt], name: "idx_applications_created_at")
  @@map("applications")
}

model LenderOffer {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  applicationId      String    @map("application_id") @db.Uuid
  lenderName        String    @map("lender_name")
  lenderLogo        String?   @map("lender_logo")
  productName       String?   @map("product_name")
  loanType          String?   @map("loan_type")
  interestRate      Decimal?  @map("interest_rate")
  apr               Decimal?
  monthlyPayment    Decimal?  @map("monthly_payment")
  closingCosts      Decimal?  @map("closing_costs")
  points            Decimal?  @map("points")
  originationFee    Decimal?  @map("origination_fee")
  loanTerm          Int?      @map("loan_term")
  rateLockDays      Int?      @map("rate_lock_days")
  rateLockExpires   DateTime? @map("rate_lock_expires") @db.Date
  isRecommended     Boolean   @default(false) @map("is_recommended")
  isBestMatch       Boolean   @default(false) @map("is_best_match")
  isVisible         Boolean   @default(true) @map("is_visible")
  source            String?   @default("manual") @map("source")
  externalId        String?   @map("external_id")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  @@index([applicationId], name: "idx_lender_offers_application_id")
  @@map("lender_offers")
}

model AdminActivityLog {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  adminId     String   @map("admin_id")
  action      String
  targetType  String?  @map("target_type")
  targetId    String?  @map("target_id")
  details     Json?
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([adminId], name: "idx_admin_activity_admin_id")
  @@index([createdAt], name: "idx_admin_activity_created_at")
  @@map("admin_activity_log")
}

model SystemMetric {
  key        String   @id
  value      Json
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("system_metrics")
}

// ==========================================
// Document Hub
// ==========================================

model Document {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String    @map("user_id")
  applicationId   String?   @map("application_id") @db.Uuid
  category        String    // e.g. government_id, proof_of_income, contract, pre_approval, etc.
  fileName        String    @map("file_name")
  storageKey      String    @map("storage_key")   // S3/Spaces object key
  fileSize        Int?      @map("file_size")      // bytes
  mimeType        String?   @map("mime_type")
  uploadedBy      String    @map("uploaded_by")    // "client" or "admin"
  uploadedByName  String?   @map("uploaded_by_name")
  status          String    @default("pending_review") // pending_review, approved, rejected
  adminNotes      String?   @map("admin_notes")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([userId], name: "idx_documents_user_id")
  @@index([applicationId], name: "idx_documents_application_id")
  @@index([category], name: "idx_documents_category")
  @@map("documents")
}
